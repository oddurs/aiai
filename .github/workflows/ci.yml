name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linters
        run: pip install ruff mypy

      - name: Ruff lint
        run: ruff check . || echo "No Python files to lint"

      - name: Mypy type check
        run: mypy . --ignore-missing-imports || echo "No Python files to type-check"

      - name: Shellcheck
        run: |
          sudo apt-get install -y shellcheck
          shellcheck scripts/*.sh || echo "Shellcheck completed with warnings"

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install test dependencies
        run: pip install pytest

      - name: Run tests
        run: |
          if [ -d "tests" ] && find tests -name "*.py" | head -1 | grep -q .; then
            pytest tests/ -v
          else
            echo "No tests found -- skipping"
          fi

  auto-label:
    name: Auto-label PR
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Label PR by file paths
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const labels = new Set();
            for (const file of files) {
              const path = file.filename;
              if (path.startsWith('docs/'))           labels.add('docs');
              if (path.startsWith('scripts/'))        labels.add('tooling');
              if (path.startsWith('.github/'))         labels.add('ci');
              if (path.startsWith('tests/'))           labels.add('tests');
              if (path.startsWith('src/'))             labels.add('source');
              if (path.startsWith('config/'))          labels.add('config');
              if (path.endsWith('.py'))                labels.add('python');
              if (path.endsWith('.sh'))                labels.add('shell');
              if (path === 'CLAUDE.md')                labels.add('agent-config');
            }

            // Detect AI-authored PRs
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            if (pr.body && pr.body.includes('ai-authored')) {
              labels.add('ai-authored');
            }

            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [...labels],
              });
            }
